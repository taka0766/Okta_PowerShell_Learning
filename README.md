# Okta PowerShell 学習用スクリプト集

このリポジトリは、Okta API を PowerShell から操作するための学習用スクリプト集です。各スクリプトは、特定のユースケースを想定して作成されており、現時点で動作未検証です。実務環境で使用する際は、十分なテストを行い、運用前に検証を行うことをお勧めします。

## スクリプト一覧

### 1. `Studies_4_school.ps1`

* **ユースケース:** 学校や大学などの新入生向けのOktaユーザーアカウントを自動作成する必要がある環境。
* **説明:** CSVファイルから学籍情報を読み込み、Okta API を使用して、各学生の Okta ユーザーアカウントを自動的に作成します。これにより、大量の学生アカウント作成作業を効率化し、人的ミスの削減に繋がります。
* **想定環境:**
    * Okta API が利用可能な環境
    * 学籍情報が記載された CSV ファイル
    * 学生のメールアドレスに使用するドメインが Okta に登録済みであること

### 2. `Studies_4_Gov.ps1`

* **ユースケース:** 官公庁や大規模な組織で、職位や部署に応じた厳格なアクセス権管理が求められる環境。
* **説明:** CSVファイルから職員情報を読み込み、Okta API を使用して、各職員を職位・部署に対応する Okta グループに自動的に追加します。これにより、手動でのグループ追加作業を削減し、効率的なアクセス権管理を実現します。
* **想定環境:**
    * Okta API が利用可能な環境
    * 職員情報が記載された CSV ファイル
    * 職位・部署に対応する Okta グループが事前に作成されていること

## 実行方法【動作未検証】

以下の手順に従い、スクリプトを実行します。

1. **CSVファイルの配置:** `EmployeeData.csv` または `StudentData.csv` をスクリプトと同じディレクトリに配置します。
2. **Okta API 設定:** スクリプト内の `$OktaApiUrl` と `$OktaApiKey` 変数を実際の Okta 環境に合わせて設定します。
3. **PowerShell 実行:** PowerShell コンソールで、スクリプトを実行します。

### 引数

- **StudentDataPath**: 学籍情報が記載されたCSVファイルのパスを指定します。
- **EmployeeDataPath**: 職員情報が記載されたCSVファイルのパスを指定します。
- **OktaApiUrl**: Okta APIのURL（例: `https://your-okta.com/api/v1`）を指定します。
- **OktaApiKey**: Okta APIキー（SSWS トークン）を指定します。
- **EnableLogging**: ログ出力を有効にするオプションです。指定した場合のみログが出力されます。

### ログファイル名の例

実行時のタイムスタンプをファイル名に追加してログを保存します。例: `Okta_User_4_Gov_Creation_Log_2025-05-06_13-45-00.txt`

## 注意事項

- **動作未検証:** このスクリプトは学習用であり、実務環境での動作は未検証です。運用に使用する前に十分なテストを行ってください。
- **APIキーの管理:** Okta API キーなどの機密情報は、スクリプト内に直接記述せず、環境変数などを利用して安全に管理してください。
- **CSVファイルの形式:** CSVファイルの形式は、スクリプト内のプロパティ名と一致するようにしてください。

## 実装済みの改善点

### 1. 通信リトライ機能の追加
通信エラーが発生した際に、指定した回数までリトライが自動的に行われるようにしました。リトライ回数を超えた場合にはエラーメッセージとともに処理が停止し、通信の不安定さを補完します。

### 2. ログ出力の改善
実行時にタイムスタンプを付けたファイル名でログが保存されるようになり、複数回の実行結果を区別できるようになりました。また、ログには通信エラーやリトライ回数、処理結果（成功・失敗）などが記録され、後から確認できるようになりました。

### 3. 強制終了機能の追加
スクリプト実行中にCtrl+CやEscキーで強制終了が可能になり、その情報をログとして記録します。これにより予期しない停止に対する対策が実装されています。

### 4. リトライ機能の共通化
複数のAPI通信部分にリトライ機能を共通化しました。通信エラーが発生した場合でも、スクリプト全体の処理が停止することなく、一定回数のリトライが自動で行われます。

## ToDo

* スクリプトの動作確認
* ~~エラーハンドリングの追加~~
* ~~ログ出力機能の追加~~
* `Studies_4_school.ps1` について、卒業生の卒業時に Okta アカウントを自動的に削除する機能の追加
